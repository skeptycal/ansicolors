# Pipeline template that creates a model package and adds the package location to the environment for subsequent tasks to use.
parameters:
- name: modelId
  type: string
  default: ''
- name: workingDirectory
  type: string
  default: ''
- name: inferencePath
  type: string
  default: ''
- name: outputImageLocationPath
  type: string
  default: image_location.txt

steps:
  - task: AzureCLI@1
    displayName: 'Install AzureML CLI'
    inputs:
      azureSubscription: '$(WORKSPACE_SVC_CONNECTION)'
      scriptLocation: inlineScript
      workingDirectory: $(Build.SourcesDirectory)
      inlineScript: 'az extension add -n azure-cli-ml'
  - task: AzureCLI@1
    displayName: 'Create model package and set IMAGE_LOCATION variable'
    inputs:
      workingDirectory: '${{ parameters.workingDirectory }}'
      azureSubscription: '$(WORKSPACE_SVC_CONNECTION)'
      scriptLocation: inlineScript
      inlineScript: |
        set -e # fail on error

        # Create model package using CLI
        IMAGE_LOCATION=$(\
        az ml model package --workspace-name $(WORKSPACE_NAME) -g $(RESOURCE_GROUP) \
        --model '${{ parameters.modelId }}' \
        --ic '${{ parameters.inferencePath }}' \
        -v \
        --query 'location' -o tsv)

        # Set environment variable
        echo $IMAGE_LOCATION
        echo "##vso[task.setvariable variable=IMAGE_LOCATION]$IMAGE_LOCATION"
  - script: echo $(IMAGE_LOCATION) >${{ parameters.outputImageLocationPath }}
    displayName: "Write image location file"
